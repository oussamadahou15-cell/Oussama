<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منصة الدروس الجامعية</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 50%, #1e8449 100%); min-height: 100vh; padding: 10px; }
.container { max-width: 1000px; margin: auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 15px 50px rgba(0,0,0,0.3); }
header { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; text-align: center; padding: 25px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
header h1 { font-size: 28px; margin-bottom: 8px; }
header h1 i { font-size: 34px; vertical-align: middle; margin-left: 10px; }
#userWelcome { font-size: 16px; margin-top: 10px; }
.logout-btn { background: #e74c3c; color: white; border: none; padding: 10px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; margin-top: 15px; }
.tabs { display: flex; background: #f8f9fa; border-bottom: 3px solid #27ae60; overflow-x: auto; }
.tab { flex: 1; padding: 16px 10px; text-align: center; cursor: pointer; font-weight: 600; color: #555; border: none; background: none; min-width: 120px; }
.tab:hover { background: #e8f5e9; color: #27ae60; }
.tab.active { background: white; color: #27ae60; border-bottom: 4px solid #27ae60; }
.content { padding: 25px; min-height: 450px; }
.section { display: none; }
.section.active { display: block; }
.section h3 { color: #27ae60; margin-bottom: 20px; font-size: 24px; padding-bottom: 12px; border-bottom: 3px solid #27ae60; }
.subjects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
.subject-card { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; padding: 25px; border-radius: 15px; cursor: pointer; transition: all 0.3s; text-align: center; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); }
.subject-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(39, 174, 96, 0.5); }
.subject-card i { font-size: 42px; margin-bottom: 15px; display: block; }
.subject-card h4 { font-size: 18px; margin-bottom: 8px; }
.lesson-count { font-size: 13px; opacity: 0.9; margin-top: 10px; }
.lessons-list { margin-top: 20px; }
.lesson-item { background: white; border: 2px solid #e8f5e9; padding: 18px; margin: 12px 0; border-radius: 12px; border-right: 5px solid #27ae60; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
.lesson-item a { color: #27ae60; text-decoration: none; font-weight: 600; cursor: pointer; flex: 1; }
.file-size { color: #7f8c8d; font-size: 13px; padding: 6px 14px; background: #ecf0f1; border-radius: 20px; margin: 0 10px; }
.delete-btn { background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
input[type="text"], input[type="email"], input[type="password"], input[type="file"], select { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e8f5e9; border-radius: 10px; font-size: 15px; }
button.primary-btn { padding: 14px; width: 100%; border: none; border-radius: 10px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); color: white; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 15px; }
button.primary-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.message { margin-top: 20px; padding: 15px; border-radius: 10px; font-weight: 600; text-align: center; }
.message.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
.message.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
.message.info { background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb; }
.loading { text-align: center; padding: 50px; color: #7f8c8d; }
.empty-state { text-align: center; padding: 60px 20px; color: #7f8c8d; }
.back-btn { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; }
.progress-bar { width: 100%; height: 8px; background: #ecf0f1; border-radius: 10px; margin: 15px 0; display: none; }
.progress-bar.active { display: block; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); border-radius: 10px; transition: width 0.3s; width: 0%; }
</style>
</head>
<body>
<div class="container">
<header>
<h1><i class="fas fa-university"></i>منصة الدروس الجامعية</h1>
<p id="userWelcome">مرحباً بك في منصة الدروس</p>
<button id="logoutBtn" class="logout-btn" style="display:none;">تسجيل الخروج</button>
</header>
<div class="tabs">
<button class="tab active" data-tab="subjects">المقاييس</button>
<button class="tab" data-tab="manage" id="manageTab" style="display:none">إدارة المقاييس</button>
<button class="tab" data-tab="upload" id="uploadTab" style="display:none">رفع درس</button>
<button class="tab" data-tab="login" id="loginTab">تسجيل الدخول</button>
</div>
<div class="content">
<div id="subjects" class="section active">
<h3>المقاييس المتاحة</h3>
<div id="subjectsGrid" class="subjects-grid"><div class="loading">جاري تحميل المقاييس...</div></div>
</div>
<div id="lessons" class="section">
<button class="back-btn" id="backToSubjects">← الرجوع للمقاييس</button>
<h3 id="lessonsSectionTitle">دروس المقياس</h3>
<div id="lessonsContainer"><div class="loading">جاري تحميل الدروس...</div></div>
</div>
<div id="manage" class="section">
<h3>إدارة المقاييس</h3>
<div style="margin-bottom: 30px;">
<h4 style="color: #27ae60; margin-bottom: 15px;">إضافة مقياس جديد</h4>
<input type="text" id="newSubjectName" placeholder="اسم المقياس">
<select id="newSubjectIcon">
<option value="fa-calculator">رياضيات</option>
<option value="fa-atom">فيزياء</option>
<option value="fa-flask">كيمياء</option>
<option value="fa-laptop-code">برمجة</option>
<option value="fa-book">عام</option>
</select>
<button class="primary-btn" id="addSubjectBtn">إضافة المقياس</button>
</div>
<div id="manageMsg"></div>
<div id="subjectsList" style="margin-top: 30px;"></div>
</div>
<div id="upload" class="section">
<h3>رفع درس جديد</h3>
<select id="uploadSubjectSelect"><option value="">اختر المقياس</option></select>
<input type="text" id="lessonTitle" placeholder="عنوان الدرس">
<input type="file" id="lessonFile" accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.zip">
<div class="progress-bar" id="uploadProgress">
<div class="progress-fill" id="progressFill"></div>
</div>
<button class="primary-btn" id="uploadBtn">رفع الدرس</button>
<div id="uploadMsg"></div>
</div>
<div id="login" class="section">
<h3>تسجيل دخول المسؤول</h3>
<input type="email" id="email" placeholder="البريد الإلكتروني" value="dhwasamt387@gmail.com">
<input type="password" id="password" placeholder="كلمة المرور" value="oussama123">
<button class="primary-btn" id="loginBtn">دخول</button>
<div id="loginMsg"></div>
</div>
</div>
</div>

<script>
(function() {
  'use strict';
  
  // تغيير هذا الرابط بعد رفع المشروع على Render
  const API_URL = window.location.origin;
  
  const ADMIN_EMAIL = 'dhwasamt387@gmail.com';
  const ADMIN_PASSWORD = 'oussama123';
  
  let currentSubject = null;
  let allSubjects = [];
  
  // ================== دوال مساعدة ==================
  
  function showMessage(element, type, text) {
    element.className = 'message ' + type;
    element.textContent = text;
  }
  
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
  
  function checkLoginStatus() {
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const userEmail = localStorage.getItem('userEmail');
    if (isLoggedIn === 'true' && userEmail === ADMIN_EMAIL) {
      showAdminMode(userEmail);
    }
  }
  
  function showAdminMode(email) {
    document.getElementById('userWelcome').textContent = 'مرحباً أستاذ، ' + email;
    document.getElementById('manageTab').style.display = 'block';
    document.getElementById('uploadTab').style.display = 'block';
    document.getElementById('loginTab').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'inline-block';
  }
  
  function switchTab(tabName) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    
    const targetSection = document.getElementById(tabName);
    if (targetSection) targetSection.classList.add('active');
    
    const targetTab = document.querySelector('[data-tab="' + tabName + '"]');
    if (targetTab) targetTab.classList.add('active');
    
    if (tabName === 'manage') loadSubjectsForManagement();
    if (tabName === 'upload') loadSubjectsForUpload();
  }
  
  // ================== المقاييس ==================
  
  async function loadSubjects() {
    const container = document.getElementById('subjectsGrid');
    container.innerHTML = '<div class="loading">جاري تحميل المقاييس...</div>';
    
    try {
      const response = await fetch(API_URL + '/api/subjects');
      const subjects = await response.json();
      
      allSubjects = subjects;
      let html = '';
      
      subjects.forEach(subject => {
        html += `
          <div class="subject-card" onclick="viewSubjectLessons(${subject.id},'${subject.name}')">
            <i class="fas ${subject.icon}"></i>
            <h4>${subject.name}</h4>
            <div class="lesson-count">${subject.lessonCount || 0} دروس</div>
          </div>
        `;
      });
      
      container.innerHTML = html || '<div class="empty-state">لا توجد مقاييس حالياً</div>';
    } catch (error) {
      container.innerHTML = '<div class="empty-state" style="color: #e74c3c;">خطأ: ' + error.message + '</div>';
    }
  }
  
  async function addSubject() {
    const name = document.getElementById('newSubjectName').value.trim();
    const icon = document.getElementById('newSubjectIcon').value;
    const msgElement = document.getElementById('manageMsg');
    
    if (!name) {
      showMessage(msgElement, 'error', 'الرجاء إدخال اسم المقياس');
      return;
    }
    
    try {
      const response = await fetch(API_URL + '/api/subjects', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, icon })
      });
      
      if (response.ok) {
        showMessage(msgElement, 'success', 'تم إضافة المقياس بنجاح');
        document.getElementById('newSubjectName').value = '';
        loadSubjects();
        loadSubjectsForManagement();
        loadSubjectsForUpload();
      }
    } catch (error) {
      showMessage(msgElement, 'error', 'خطأ: ' + error.message);
    }
  }
  
  async function loadSubjectsForManagement() {
    const container = document.getElementById('subjectsList');
    
    try {
      const response = await fetch(API_URL + '/api/subjects');
      const subjects = await response.json();
      
      if (subjects.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#7f8c8d;">لا توجد مقاييس</p>';
        return;
      }
      
      let html = '<h4 style="color: #e74c3c; margin-bottom: 15px;">المقاييس الحالية</h4>';
      subjects.forEach(subject => {
        html += `
          <div class="lesson-item">
            <span><i class="fas ${subject.icon}" style="margin-left: 10px;"></i>${subject.name}</span>
            <button class="delete-btn" onclick="deleteSubject(${subject.id},'${subject.name}')">حذف</button>
          </div>
        `;
      });
      container.innerHTML = html;
    } catch (error) {
      console.error('Error:', error);
    }
  }
  
  async function loadSubjectsForUpload() {
    const select = document.getElementById('uploadSubjectSelect');
    
    try {
      const response = await fetch(API_URL + '/api/subjects');
      const subjects = await response.json();
      
      let html = '<option value="">اختر المقياس</option>';
      subjects.forEach(subject => {
        html += `<option value="${subject.id}">${subject.name}</option>`;
      });
      select.innerHTML = html;
    } catch (error) {
      console.error('Error:', error);
    }
  }
  
  window.deleteSubject = async function(id, name) {
    if (!confirm('هل تريد حذف "' + name + '"؟ سيتم حذف جميع الدروس!')) return;
    
    try {
      const response = await fetch(API_URL + '/api/subjects/' + id, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        loadSubjects();
        loadSubjectsForManagement();
        loadSubjectsForUpload();
      }
    } catch (error) {
      alert('خطأ: ' + error.message);
    }
  };
  
  // ================== الدروس ==================
  
  window.viewSubjectLessons = async function(subjectId, subjectName) {
    currentSubject = subjectId;
    document.getElementById('lessonsSectionTitle').textContent = 'دروس ' + subjectName;
    switchTab('lessons');
    
    const container = document.getElementById('lessonsContainer');
    container.innerHTML = '<div class="loading">جاري تحميل الدروس...</div>';
    
    try {
      const response = await fetch(API_URL + '/api/lessons/' + subjectId);
      const lessons = await response.json();
      
      if (lessons.length === 0) {
        container.innerHTML = '<div class="empty-state">لا توجد دروس في هذا المقياس</div>';
        return;
      }
      
      const isAdmin = localStorage.getItem('isLoggedIn') === 'true';
      let html = '<div class="lessons-list">';
      
      lessons.forEach(lesson => {
        const fileSize = formatFileSize(lesson.fileSize || 0);
        html += `
          <div class="lesson-item">
            <a href="${API_URL}${lesson.fileUrl}" target="_blank" download="${lesson.fileName}">
              ${lesson.title}
            </a>
            <span class="file-size">${fileSize}</span>
            ${isAdmin ? `<button class="delete-btn" onclick="deleteLesson(${lesson.id}, ${subjectId})">حذف</button>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    } catch (error) {
      container.innerHTML = '<div class="empty-state" style="color: #e74c3c;">خطأ: ' + error.message + '</div>';
    }
  };
  
  async function uploadLesson() {
    const subjectId = document.getElementById('uploadSubjectSelect').value;
    const title = document.getElementById('lessonTitle').value.trim();
    const fileInput = document.getElementById('lessonFile');
    const file = fileInput.files[0];
    const msgElement = document.getElementById('uploadMsg');
    const progressBar = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const uploadBtn = document.getElementById('uploadBtn');
    
    if (!subjectId) {
      showMessage(msgElement, 'error', 'اختر المقياس');
      return;
    }
    if (!title || !file) {
      showMessage(msgElement, 'error', 'أدخل العنوان واختر ملف');
      return;
    }
    
    try {
      uploadBtn.disabled = true;
      progressBar.classList.add('active');
      showMessage(msgElement, 'info', 'جاري رفع الملف...');
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('title', title);
      formData.append('subjectId', subjectId);
      
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          progressFill.style.width = percent + '%';
        }
      });
      
      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          showMessage(msgElement, 'success', 'تم رفع الدرس بنجاح!');
          document.getElementById('lessonTitle').value = '';
          fileInput.value = '';
          uploadBtn.disabled = false;
          progressBar.classList.remove('active');
          progressFill.style.width = '0%';
          loadSubjects();
          
          setTimeout(() => {
            msgElement.innerHTML = '';
          }, 3000);
        } else {
          throw new Error('فشل رفع الملف');
        }
      });
      
      xhr.addEventListener('error', () => {
        throw new Error('خطأ في الاتصال');
      });
      
      xhr.open('POST', API_URL + '/api/lessons');
      xhr.send(formData);
      
    } catch (error) {
      uploadBtn.disabled = false;
      progressBar.classList.remove('active');
      showMessage(msgElement, 'error', 'خطأ: ' + error.message);
    }
  }
  
  window.deleteLesson = async function(lessonId, subjectId) {
    if (!confirm('هل تريد حذف هذا الدرس؟')) return;
    
    try {
      const response = await fetch(API_URL + '/api/lessons/' + lessonId, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        const subject = allSubjects.find(s => s.id === subjectId);
        if (subject) {
          viewSubjectLessons(subjectId, subject.name);
        }
        loadSubjects();
      }
    } catch (error) {
      alert('خطأ: ' + error.message);
    }
  };
  
  // ================== تسجيل الدخول ==================
  
  function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const msgElement = document.getElementById('loginMsg');
    
    if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
      localStorage.setItem('isLoggedIn', 'true');
      localStorage.setItem('userEmail', email);
      showAdminMode(email);
      switchTab('subjects');
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      msgElement.innerHTML = '';
    } else {
      showMessage(msgElement, 'error', 'بيانات خاطئة');
    }
  }
  
  function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userEmail');
    document.getElementById('userWelcome').textContent = 'مرحباً بك في منصة الدروس';
    document.getElementById('manageTab').style.display = 'none';
    document.getElementById('uploadTab').style.display = 'none';
    document.getElementById('loginTab').style.display = 'block';
    document.getElementById('logoutBtn').style.display = 'none';
    switchTab('subjects');
  }
  
  // ================== Event Listeners ==================
  
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('addSubjectBtn').addEventListener('click', addSubject);
    document.getElementById('uploadBtn').addEventListener('click', uploadLesson);
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        switchTab(this.getAttribute('data-tab'));
      });
    });
    
    document.getElementById('backToSubjects').addEventListener('click', function() {
      switchTab('subjects');
    });
    
    checkLoginStatus();
    loadSubjects();
  });
  
})();
</script>
</body>
</html>
